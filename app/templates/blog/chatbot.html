<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href = "{{ url_for('static',filename='style/chatbot.css') }}"/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/lib/languages/python.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/a11y-dark.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>    
    </head>
    <body>
        <header class="main-header">
            <div class="container">
                <nav class="navbar navbar-expand-lg main-nav px-0">
                    <div class="collapse navbar-collapse" id="mainMenu">
                        <ul class="navbar-nav ml-auto text-uppercase f1">
                            <li><a href="#">User Information</a></li>
                            <li><a href="#">Settings</a></li>
                            <li><a href="/home">Exit</a></li>
                        </ul>
                        <div class="container-user-info">
                            <div class="container-user-image">
                                {% if user_image %}
                                <img src="{{ user_image }}">
                                {% endif %}
                            </div>
                            <div class="container-username">
                                <p class="container-username-text" type="text" value="{{ user_name }}">
                                </p>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>
        <p class = "tree-name">session</p>
        <div class="chatbot-workspace-container">
            <div class ="tree-container">
                <ul class = "tree-view">
                </ul>
            </div>
            <div class="chat-container">
                <div class="chat-box mt-3">
                </div>
                <div class="form-group-user">
                    <form action = "/chatbot", method = POST>
                        <textarea class="form-control-user" rows="1" placeholder="Nhập câu lệnh" id="message-input" name="prompt"></textarea>
                    </form>
                </div>
                <button type="button" class="btn" id="send-btn">Send</button>
            </div>
        </div>
        <div class = "fixed-box">
            <div class = "label-policy">Privacy @2023</div>
        </div>
        <script>
            setInterval(highlightAll, 1000);
            // Function to highlight code using highlight.js library
            function highlightAll() {
                document.querySelectorAll("pre code").forEach(block => {
                    hljs.highlightBlock(block);
                });
            }
            const treeview = document.querySelector(".tree-view")
            const chatBox = document.querySelector(".chat-box");
            const messageInput = document.querySelector("#message-input");
            const sendBtn = document.querySelector("#send-btn")
            const chatContainer = document.querySelector(".chatbot-workspace-container")
            
            function addMessage(message, isUserMessage) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("mt-3", "p-3", "rounded");
                const treeItem = document.createElement("li");
                treeItem.addEventListener("click", function viewItem(event) {
                    // Get the clicked `li` tag.
                    const li = event.target;
                    // Get the item view text.
                    const item_view = li.getElementsByTagName('p')[0].innerHTML;
                    // Get the first chat box element.
                    const chatBoxElement = document.querySelector(".chat-box");
                    // Scroll the chat box element into view if its inner text matches the item view text.
                    if (chatBoxElement.querySelector('p').textContent === item_view) {
                        chatBoxElement.scrollIntoView(true);
                        chatBoxElement.scrollIntoView({ smooth: true });
                    }
                });
                const messageInput = document.querySelector("tree-view");
            
                if (isUserMessage) {
                    messageDiv.classList.add("user-message");
                    treeItem.classList.add("tree-item")
                } else {
                    messageDiv.classList.add("bot-message");
                }
                messageDiv.innerHTML = `<img src="{{ url_for('static',filename='style/images/icons-user.png') }}" class="user-icon"><p>${message}</p>`;
                treeItem.innerHTML = `<li class="tree-item-click"><img src="{{ url_for('static',filename='style/images/icons-message.png') }}" class ="icons-message">${message}</li>`;            
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                treeview.appendChild(treeItem)
                treeview.scrollTop = chatBox.scrollHeight;
            } 
            async function sendMessage() {
                const message = messageInput.value.trim();
                if (message !== "") {
                    // Add a loading indicator
                    const loadingIndicator = document.createElement("div");
                    loadingIndicator.classList.add("loader");
                    chatContainer.appendChild(loadingIndicator);
                    // Add the user's message to the chat box
                    addMessage(message, true);
                    // Send the message to the bot
                    try {
                        const response = await fetch("/openai_api", {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({ message }),
                        });
                      
                        // Get the bot's response
                        const data = await response.json();
                      
                        // Escape any HTML entities in the bot's response
                        try{
                            const escapedContent = data.content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
                            const data = escapedContent
                        } catch(error) {
                            console.error(error);
                        }
                      
                        // Remove the loading indicator
                        const loadingIndicator = document.querySelector(".loader");
                        loadingIndicator.remove();
                      
                        // Add the bot's response to the chat box
                        const messageDiv = document.createElement("div");
                        messageDiv.classList.add("mt-3", "p-3", "rounded");
                        messageDiv.classList.add("bot-message");
                        messageDiv.innerHTML = `<img src="{{ url_for('static',filename='style/images/icons-bot.png') }}" class="bot-icon"><p>${data}</p>`;
                        chatBox.appendChild(messageDiv);
                      
                        // Scroll the chat box to the bottom
                        chatBox.scrollTop = chatBox.scrollHeight;
                    } catch (error) {
                        // Log the error
                        console.error("Failed to fetch bot response:", error);
                      
                        // Show a more specific error message to the user
                        const errorMessageDiv = document.createElement("div");
                        errorMessageDiv.classList.add("mt-3", "p-3", "rounded");
                        errorMessageDiv.classList.add("error-message");
                        errorMessageDiv.innerHTML = `<p>Oops, something went wrong while fetching the bot response: ${error.message}</p>`;
                        chatBox.appendChild(errorMessageDiv);
                      
                        // Remove the loading indicator even if there is an error
                        const loadingIndicator = document.querySelector(".loader");
                        loadingIndicator.remove();
                    }
                    // Clear the message input
                    messageInput.value = "";
                }
            }
            sendBtn.addEventListener("click", sendMessage);
            messageInput.addEventListener("keydown", event => {
                if (event.keyCode === 13 && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
        </script>
    </body>
</html>